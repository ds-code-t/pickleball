plugins {
    id 'java-library'
    id 'maven-publish'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
}

group = "tools.dscode"
version = "1.0"

// keep this in sync with your fork build (you can override with -PcukeVer=7.30.0)
ext.cukeVer = (findProperty("cukeVer") ?: "7.30.0")

java {
    toolchain { languageVersion = JavaLanguageVersion.of(21) }
    withSourcesJar()   // optional
    withJavadocJar()   // optional
}

repositories {
    mavenLocal()
    mavenCentral()
}

/* =========================
   RUNTIME API FOR CONSUMERS
   ========================= */

dependencies {
    // Expose JUnit API & Suite annotations so consumers can compile and run tests
    api("org.junit.jupiter:junit-jupiter-api:5.10.2")
    api("org.junit.platform:junit-platform-suite-api:1.10.2")

    // Engines & launcher so Maven Surefire picks the JUnit Platform provider
    api("org.junit.jupiter:junit-jupiter-engine:5.10.2")
    api("org.junit.platform:junit-platform-engine:1.10.2")
    api("org.junit.platform:junit-platform-launcher:1.10.2")
    api("org.junit.platform:junit-platform-suite-engine:1.10.2")
}

/* =========================
   BUILD-TIME OFFLINE WEAVER
   ========================= */

sourceSets {
    // Build-time only weaver code (not shipped in the shaded jar)
    weaver {
        java.srcDir 'src/weaver/java'
        compileClasspath += sourceSets.main.compileClasspath
        runtimeClasspath += sourceSets.main.runtimeClasspath
    }
}

configurations {
    weaverImplementation.extendsFrom implementation
    // compile-only deps just for the weaver source set
    weaverCompileOnly
}

dependencies {
    // Byte Buddy for offline weaving (weaver source set only)
    weaverImplementation("net.bytebuddy:byte-buddy:1.14.18")
    // If your weaver/advices reference agent-specific annotations/utilities, uncomment:
    // weaverImplementation("net.bytebuddy:byte-buddy-agent:1.14.18")

    // Let the weaver import Cucumber types (type-safe), compile-only (NOT shipped)
    weaverCompileOnly("io.cucumber:cucumber-core:${cukeVer}")
    weaverCompileOnly("io.cucumber:cucumber-java:${cukeVer}")
    weaverCompileOnly("io.cucumber:cucumber-junit:${cukeVer}")
    weaverCompileOnly("io.cucumber:cucumber-junit-platform-engine:${cukeVer}")
    weaverCompileOnly("io.cucumber:cucumber-plugin:${cukeVer}")
    weaverCompileOnly("io.cucumber:cucumber-gherkin:${cukeVer}")
    weaverCompileOnly("io.cucumber:cucumber-gherkin-messages:${cukeVer}")
    weaverCompileOnly("io.cucumber:datatable:${cukeVer}")
    weaverCompileOnly("io.cucumber:datatable-matchers:${cukeVer}")
    weaverCompileOnly("io.cucumber:docstring:${cukeVer}")
    // If your DSL imports your new module:
    weaverCompileOnly("io.cucumber:cucumber-pickleball-common:${cukeVer}")
}

// ensure your fork jars exist in ~/.m2 BEFORE compiling the weaver
tasks.named("compileWeaverJava").configure { dependsOn("buildFork") }

/* Helper to resolve the exact Cucumber jars we will weave and later shade */
// Helper you already have (or add if missing)
def resolveCukeJars = { String cv ->
    project.configurations.detachedConfiguration(
            project.dependencies.create("io.cucumber:cucumber-pickleball-common:${cv}"),
            project.dependencies.create("io.cucumber:cucumber-core:${cv}"),
            project.dependencies.create("io.cucumber:cucumber-java:${cv}"),
            project.dependencies.create("io.cucumber:cucumber-junit:${cv}"),
            project.dependencies.create("io.cucumber:cucumber-junit-platform-engine:${cv}"),
            project.dependencies.create("io.cucumber:cucumber-plugin:${cv}"),
            project.dependencies.create("io.cucumber:cucumber-gherkin:${cv}"),
            project.dependencies.create("io.cucumber:cucumber-gherkin-messages:${cv}"),
            project.dependencies.create("io.cucumber:datatable:${cv}"),
            project.dependencies.create("io.cucumber:datatable-matchers:${cv}"),
            project.dependencies.create("io.cucumber:docstring:${cv}")
            // DO NOT include cucumber-bom here (it's a POM, not a JAR)
    ).resolve().findAll { it.name.endsWith(".jar") }
}

tasks.register("weaveCucumber") {
    group = "build"
    description = "Offline-weaves Cucumber classes (one JavaExec per jar)"
    dependsOn("compileWeaverJava")

    // Use your property or default
    def cv = (findProperty("cukeVer") ?: "7.30.0")

    // Resolve once; we also use this list as the resolver classpath
    def allJars = resolveCukeJars(cv)

    inputs.files(allJars)
    outputs.dir("$buildDir/weaved-jars")

    doLast {
        def outDir = file("$buildDir/weaved-jars")
        outDir.mkdirs()

        // The resolver classpath we pass to the weaver (all related jars)
        def cpString = allJars.collect { it.absolutePath }.join(File.pathSeparator)

        allJars.each { File inJar ->
            def outJar = new File(outDir, inJar.name.replaceAll(/\.jar$/, "-weaved.jar"))
            logger.lifecycle("[weave] in: ${inJar}  -> out: ${outJar}")

            // â¬‡ï¸ Your snippet lives right here:
            javaexec {
                classpath = sourceSets.weaver.runtimeClasspath
                mainClass = "tools.dscode.modkit.blackbox.OfflineWeaverMain"
                args inJar.absolutePath, outJar.absolutePath

                // Memory and system properties for the weaver
                jvmArgs "-Xmx1g",
                        "-Dweaver.classpath=${cpString}",
                        // target packages to weave (includes messages.* for Pickle#getTags)
                        "-Dweaver.targets=io.cucumber.core.,io.cucumber.messages.,io.cucumber.gherkin.,io.cucumber.plugin."
            }
        }
    }
}



/* =========================
   SHADING (ONE FAT JAR)
   ========================= */

tasks.jar { enabled = false } // publish only the shaded jar

tasks.shadowJar {
    dependsOn("weaveCucumber")

    archiveBaseName.set("pickleball")
    archiveClassifier.set("")      // publish as main (no "-all")
    archiveVersion.set(version)

    // keep original packages; merge service descriptors
    duplicatesStrategy = DuplicatesStrategy.INCLUDE
    mergeServiceFiles()

    // ðŸ”¹ Include your own code:
    // - main classes (runtime helpers your woven code may call)
    // - weaver classes (Plans/Registry/advices/etc.) so NoClassDefFoundError disappears
    from(sourceSets.main.output)
    from(sourceSets.weaver.output)

    doFirst {
        // Use weaved jars if present; otherwise fall back to originals
        def originals = resolveCukeJars(cukeVer)
        def weavedDir = file("$buildDir/weaved-jars")
        def weaved = weavedDir.exists()
                ? weavedDir.listFiles({ f -> f.name.endsWith(".jar") } as java.io.FileFilter)
                : [] as File[]

        def toZip = (weaved && weaved.length > 0) ? weaved : originals
        logger.lifecycle("[shadowJar] adding ${toZip.size()} dependency jars (${(weaved && weaved.length>0) ? 'weaved' : 'original'})")

        // Unzip deps into the fat jar
        toZip.each { File f -> from(project.zipTree(f)) }
    }
}



/* =========================
   PUBLISHING (NO io.cucumber:* IN POM)
   ========================= */

publishing {
    publications {
        mavenJava(MavenPublication) {
            groupId = project.group
            artifactId = "pickleball"
            version = project.version

            // Publish the shaded jar as the main artifact
            artifact(tasks.shadowJar)

            // Author the POM so consumers get JUnit 5 transitively (but no Cucumber)
            pom.withXml { xml ->
                def root = xml.asNode()

                // Clean out any existing <dependencies>
                root.get('dependencies')?.each { root.remove(it) }

                // Create a fresh <dependencies> block with JUnit 5 entries
                def depsNode = root.appendNode('dependencies')
                def addDep = { g, a, v, s ->
                    def d = depsNode.appendNode('dependency')
                    d.appendNode('groupId', g)
                    d.appendNode('artifactId', a)
                    d.appendNode('version', v)
                    if (s) d.appendNode('scope', s) // 'compile' so Surefire sees them
                }

                addDep('org.junit.jupiter',  'junit-jupiter-api',         '5.10.2', 'compile')
                addDep('org.junit.jupiter',  'junit-jupiter-engine',      '5.10.2', 'compile')
                addDep('org.junit.platform', 'junit-platform-engine',     '1.10.2', 'compile')
                addDep('org.junit.platform', 'junit-platform-launcher',   '1.10.2', 'compile')
                addDep('org.junit.platform', 'junit-platform-suite-api',  '1.10.2', 'compile')
                addDep('org.junit.platform', 'junit-platform-suite-engine','1.10.2','compile')
            }
        }
    }
    repositories { mavenLocal() }
}

/* =========================
   BUILD YOUR FORK FIRST
   ========================= */

import org.gradle.internal.os.OperatingSystem

// Build only the modules you want into ~/.m2 (Pico excluded)
def includeModules = [
        "cucumber-pickleball-common",
        "cucumber-bom",
        "cucumber-plugin",
        "cucumber-gherkin",
        "cucumber-gherkin-messages",
        "datatable",
        "docstring",
        "cucumber-core",
        "cucumber-junit-platform-engine",
        "cucumber-java",
        "cucumber-junit",
        // "cucumber-spring",
        // "cucumber-testng",
]

tasks.register("buildFork") {
    group = "build"
    description = "Builds selected cucumber-jvm modules into mavenLocal (excludes Pico)"

    doLast {
        def isWin = OperatingSystem.current().isWindows()
        def wrapper = file(isWin ? "cucumber-jvm/mvnw.cmd" : "cucumber-jvm/mvnw")
        def useWrapper = wrapper.exists()
        def modulesArg = includeModules.join(",")

        def cmd
        if (useWrapper) {
            if (!isWin) {
                exec { workingDir = file("cucumber-jvm"); commandLine "bash","-lc","chmod +x ./mvnw" }
            }
            cmd = isWin
                    ? [wrapper.absolutePath, "-DskipTests", "clean", "install", "-pl", modulesArg, "-am"]
                    : ["bash","-lc","./mvnw -DskipTests clean install -pl " + modulesArg + " -am"]
        } else {
            cmd = isWin
                    ? ["cmd","/c","mvn","-DskipTests","clean","install","-pl", modulesArg,"-am"]
                    : ["bash","-lc","mvn -DskipTests clean install -pl " + modulesArg + " -am"]
        }

        exec {
            workingDir = file("cucumber-jvm")
            commandLine = cmd
            standardOutput = System.out
            errorOutput = System.err
            ignoreExitValue = false
        }
    }
}

// Ensure ordering: build fork -> compile weaver -> weave -> shade -> publish
tasks.named("build").configure { dependsOn("buildFork") }
tasks.named("publishToMavenLocal").configure { dependsOn("buildFork") }
